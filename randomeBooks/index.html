<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>ブックガチャ</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  </head>
  <body>
    <div>
      <button id="bookLottery" class="btn btn-default">ガチャを回す！</button>
    </div>
    <p class="setumei">
      ランダムで生成したISBNを、実在する書籍がヒットするまで検索し続けて情報を表示します。<br />
      結果の表示に時間がかかりますが、そのままお待ちください。
    </p>

    <!-- チェックボックス -->
    <div>
      <h3>第1桁目（販売対象）</h3>
      <div id="category1">
        <label><input type="checkbox" id="selectAll1" /> 全選択</label>
        <label><input type="checkbox" value="0" /> 一般</label>
        <label><input type="checkbox" value="1" /> 教養</label>
        <label><input type="checkbox" value="2" /> 実用</label>
        <label><input type="checkbox" value="3" /> 専門</label>
        <label><input type="checkbox" value="4" /> 検定教科書</label>
        <label><input type="checkbox" value="5" /> 婦人</label>
        <label><input type="checkbox" value="6" /> 学参I（小中）</label>
        <label><input type="checkbox" value="7" /> 学参II（高校）</label>
        <label><input type="checkbox" value="8" /> 児童</label>
        <label><input type="checkbox" value="9" /> 雑誌扱い</label>
      </div>

      <h3>第2桁目（形態）</h3>
      <div id="category2">
        <label><input type="checkbox" id="selectAll2" /> 全選択</label>
        <label><input type="checkbox" value="0" /> 単行本</label>
        <label><input type="checkbox" value="1" /> 文庫</label>
        <label><input type="checkbox" value="2" /> 新書</label>
        <label><input type="checkbox" value="3" /> 全集･双書</label>
        <label><input type="checkbox" value="4" /> ムック･その他</label>
        <label><input type="checkbox" value="5" /> 事･辞典</label>
        <label><input type="checkbox" value="6" /> 図鑑</label>
        <label><input type="checkbox" value="7" /> 絵本</label>
        <label><input type="checkbox" value="8" /> 磁性媒体など</label>
        <label><input type="checkbox" value="9" /> コミック</label>
      </div>
    </div>

    <!-- サムネイル画像表示 -->
    <div id="thumbnail"></div>
    <div>書籍名：<span id="title"></span></div>
    <div>出版社：<span id="publisher"></span></div>
    <div>シリーズ：<span id="series"></span></div>
    <div>著者：<span id="author"></span></div>
    <div>出版日：<span id="pubdate"></span></div>
    <div>サムネイルURI：<span id="cover"></span></div>
    <div>ISBN：<span id="isbn"></span></div>

    <script>
      $(function () {
        function getRandomISBN() {
          const isbnPrefix = "9784";
          let isbn = isbnPrefix;
          for (let i = 0; i < 9; i++) {
            isbn += Math.floor(Math.random() * 10); // 0-9 のランダムな数字を追加
          }
          return isbn;
        }

        function isValidCategory(isbn) {
          const category1Checked = $("#category1 input:checked")
            .not("#selectAll1")
            .map(function () {
              return $(this).val();
            })
            .get();
          const category2Checked = $("#category2 input:checked")
            .not("#selectAll2")
            .map(function () {
              return $(this).val();
            })
            .get();

          const cCode1 = isbn.charAt(4); // 第1桁目（販売対象）
          const cCode2 = isbn.charAt(5); // 第2桁目（形態）

          return (
            category1Checked.includes(cCode1) &&
            category2Checked.includes(cCode2)
          );
        }

        function fetchBookData(isbn) {
          const url = "https://api.openbd.jp/v1/get?isbn=" + isbn;

          $.getJSON(url, function (data) {
            if (data && data[0] && data[0].summary) {
              const book = data[0].summary;

              // 書籍情報を表示
              $("#title").text(book.title || "タイトル情報なし");
              $("#publisher").text(book.publisher || "出版社情報なし");
              $("#series").text(book.series || "シリーズ情報なし");
              $("#author").text(book.author || "著者情報なし");
              $("#pubdate").text(book.pubdate || "出版日情報なし");
              $("#cover").text(book.cover || "サムネイル情報なし");
              $("#isbn").text(isbn); // ISBNを表示

              // サムネイル画像の表示（書影がない場合はNoImage.jpgを表示）
              const coverImage = book.cover ? book.cover : "NoImage.jpg";
              $("#thumbnail").html(
                '<img src="' +
                  coverImage +
                  '" alt="書籍画像" style="max-width: 150px; height: auto;"/>'
              );
            } else {
              console.log(`データが見つかりません: ISBN ${isbn}`);
              fetchValidISBN(); // 再検索
            }
          }).fail(function () {
            console.log("APIリクエストに失敗しました");
          });
        }

        function fetchValidISBN() {
          let isbn;
          do {
            isbn = getRandomISBN();
          } while (!isValidCategory(isbn));
          fetchBookData(isbn);
        }

        $("#selectAll1").change(function () {
          $("#category1 input").not(this).prop("checked", this.checked);
        });

        $("#selectAll2").change(function () {
          $("#category2 input").not(this).prop("checked", this.checked);
        });

        $("#bookLottery").click(function (e) {
          e.preventDefault();
          fetchValidISBN();
        });
      });
    </script>
  </body>
</html>
